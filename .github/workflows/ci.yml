name: C19 Inventory Engine CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: c19-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_and_checks:
    name: Build / Lint / Typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL || 'https://example.supabase.co' }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'anon-placeholder' }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install Dependencies
        run: npm ci

      - name: Security Audit
        run: npm audit --audit-level=high

      - name: Lint
        run: |
          echo "Running ESLint..."
          npm run lint

      - name: Typecheck
        run: npm run type-check

      - name: Build
        run: npm run build

      - name: PWA Integrity Gate
        run: npm run verify:pwa
        shell: bash

      - name: Scaling Compliance Gate
        run: npm run verify:scaling
        shell: bash

  c19_phase5_gates:
    name: C19 Phase 5 Gates
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [build_and_checks]

    # Serialize access to shared CI DB (prevents migration races)
    concurrency:
      group: c19-ci-shared-db
      cancel-in-progress: false

    # Skip forks (no secrets). Keeps internal PRs fully gated.
    if: >
      github.event_name != 'pull_request' ||
      github.event.pull_request.head.repo.full_name == github.repository

    env:
      C19_TEST_MODE: ci
      NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

    steps:
      - uses: actions/checkout@v4

      - name: CI Notice
        run: echo "C19 Phase 5 gates run only on internal PRs/pushes (forks skipped due to secrets safety)."

      - name: Start Local Supabase (CI)
        run: |
          npm i -g supabase@1.226.0
          # Initialize if not already (config.toml exists, but maybe init needed for fresh runner?)
          # Actually config.toml should be enough.
          supabase start -x studio,migra,imgproxy,deno-relay --ignore-health-check
          
          # Wait for ready
          sleep 10
          
          # Extract credentials
          STATUS=$(supabase status -o json)
          DB_URL=$(echo $STATUS | jq -r .db_url)
          SERVICE_KEY=$(echo $STATUS | jq -r .service_role_key)
          ANON_KEY=$(echo $STATUS | jq -r .anon_key)
          API_URL=$(echo $STATUS | jq -r .api_url)
          
          echo "SUPABASE_DB_URL=$DB_URL" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=$SERVICE_KEY" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_URL=$API_URL" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=$ANON_KEY" >> $GITHUB_ENV

      - name: Verify Supabase Ready
        run: |
          if [ -z "$SUPABASE_DB_URL" ]; then
            echo "❌ Failed to start local Supabase"
            exit 1
          fi
          echo "✅ Local Supabase started at $NEXT_PUBLIC_SUPABASE_URL"

      # ----------------------------
      # C19 Phase 5 Hard Gates (CI)
      # ----------------------------
      - name: 1) E2E Simulation (Full Lifecycle)
        run: npx tsx scripts/verify_c19_phase5_e2e_simulation.ts

      - name: 2) Forecast Accuracy (MAPE)
        run: npx tsx scripts/test_c19_forecast_accuracy.ts

      - name: 3) Confidence Calibration
        run: npx tsx scripts/test_c19_confidence_calibration.ts

      - name: 4) Performance Budgets
        run: npx tsx scripts/test_c19_performance_budgets.ts

      - name: 5) Conflict Safety (Offline Replay)
        run: npx tsx scripts/test_c19_offline_replay_conflicts.ts
